import React, { useState } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Slider } from "@/components/ui/slider";
import { Checkbox } from "@/components/ui/checkbox";
import { Search, X, SlidersHorizontal } from "lucide-react";
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
  SheetTrigger,
} from "@/components/ui/sheet";

export default function AdvancedSearchFilters({ 
  onFilterChange, 
  filterConfig = {},
  currentFilters = {}
}) {
  const [filters, setFilters] = useState(currentFilters);
  const [isOpen, setIsOpen] = useState(false);

  const handleFilterChange = (key, value) => {
    const newFilters = { ...filters, [key]: value };
    setFilters(newFilters);
    onFilterChange(newFilters);
  };

  const handleReset = () => {
    const resetFilters = {};
    Object.keys(filterConfig).forEach(key => {
      resetFilters[key] = filterConfig[key].default || "";
    });
    setFilters(resetFilters);
    onFilterChange(resetFilters);
  };

  const activeFilterCount = Object.values(filters).filter(v => v && v !== "all" && v !== "").length;

  return (
    <Sheet open={isOpen} onOpenChange={setIsOpen}>
      <SheetTrigger asChild>
        <Button variant="outline" className="relative">
          <SlidersHorizontal className="w-4 h-4 mr-2" />
          Advanced Filters
          {activeFilterCount > 0 && (
            <span className="absolute -top-2 -right-2 bg-orange-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
              {activeFilterCount}
            </span>
          )}
        </Button>
      </SheetTrigger>
      <SheetContent className="overflow-y-auto">
        <SheetHeader>
          <SheetTitle>Advanced Filters</SheetTitle>
          <SheetDescription>
            Refine your search with detailed filters
          </SheetDescription>
        </SheetHeader>

        <div className="space-y-6 mt-6">
          {/* Text Search */}
          {filterConfig.search && (
            <div>
              <Label htmlFor="search">Search</Label>
              <div className="relative">
                <Search className="absolute left-3 top-3 w-4 h-4 text-gray-400" />
                <Input
                  id="search"
                  placeholder={filterConfig.search.placeholder || "Search..."}
                  value={filters.search || ""}
                  onChange={(e) => handleFilterChange("search", e.target.value)}
                  className="pl-10"
                />
              </div>
            </div>
          )}

          {/* Select Dropdowns */}
          {Object.entries(filterConfig).map(([key, config]) => {
            if (config.type === "select") {
              return (
                <div key={key}>
                  <Label>{config.label}</Label>
                  <Select 
                    value={filters[key] || "all"} 
                    onValueChange={(value) => handleFilterChange(key, value)}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder={config.placeholder} />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="all">All {config.label}</SelectItem>
                      {config.options.map((option) => (
                        <SelectItem key={option} value={option}>
                          {option}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              );
            }
            return null;
          })}

          {/* Range Slider */}
          {Object.entries(filterConfig).map(([key, config]) => {
            if (config.type === "range") {
              return (
                <div key={key}>
                  <Label>{config.label}: {filters[key] || config.default}</Label>
                  <Slider
                    value={[filters[key] || config.default]}
                    onValueChange={(value) => handleFilterChange(key, value[0])}
                    min={config.min}
                    max={config.max}
                    step={config.step || 1}
                    className="mt-2"
                  />
                  <div className="flex justify-between text-xs text-gray-500 mt-1">
                    <span>{config.min}</span>
                    <span>{config.max}</span>
                  </div>
                </div>
              );
            }
            return null;
          })}

          {/* Checkboxes */}
          {Object.entries(filterConfig).map(([key, config]) => {
            if (config.type === "checkbox") {
              return (
                <div key={key}>
                  <Label className="mb-3 block">{config.label}</Label>
                  <div className="space-y-2">
                    {config.options.map((option) => (
                      <div key={option} className="flex items-center space-x-2">
                        <Checkbox
                          id={`${key}-${option}`}
                          checked={filters[key]?.includes(option)}
                          onCheckedChange={(checked) => {
                            const current = filters[key] || [];
                            const updated = checked
                              ? [...current, option]
                              : current.filter(v => v !== option);
                            handleFilterChange(key, updated);
                          }}
                        />
                        <label
                          htmlFor={`${key}-${option}`}
                          className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
                        >
                          {option}
                        </label>
                      </div>
                    ))}
                  </div>
                </div>
              );
            }
            return null;
          })}

          {/* Date Range */}
          {Object.entries(filterConfig).map(([key, config]) => {
            if (config.type === "dateRange") {
              return (
                <div key={key}>
                  <Label className="mb-2 block">{config.label}</Label>
                  <div className="grid grid-cols-2 gap-2">
                    <div>
                      <Label htmlFor={`${key}-from`} className="text-xs">From</Label>
                      <Input
                        id={`${key}-from`}
                        type="date"
                        value={filters[`${key}_from`] || ""}
                        onChange={(e) => handleFilterChange(`${key}_from`, e.target.value)}
                      />
                    </div>
                    <div>
                      <Label htmlFor={`${key}-to`} className="text-xs">To</Label>
                      <Input
                        id={`${key}-to`}
                        type="date"
                        value={filters[`${key}_to`] || ""}
                        onChange={(e) => handleFilterChange(`${key}_to`, e.target.value)}
                      />
                    </div>
                  </div>
                </div>
              );
            }
            return null;
          })}

          <div className="flex gap-2 pt-4">
            <Button onClick={handleReset} variant="outline" className="flex-1">
              <X className="w-4 h-4 mr-2" />
              Reset
            </Button>
            <Button onClick={() => setIsOpen(false)} className="flex-1 bg-orange-600 hover:bg-orange-700">
              Apply Filters
            </Button>
          </div>
        </div>
      </SheetContent>
    </Sheet>
  );
}