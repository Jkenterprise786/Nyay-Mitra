import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery } from "@tanstack/react-query";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { Building2, Search, Filter, BookmarkPlus, Bot, Loader2, Sparkles, Target, TrendingUp } from "lucide-react";
import { toast } from "sonner";

import SchemeCard from "../components/schemes/SchemeCard";
import EligibilityForm from "../components/schemes/EligibilityForm";

export default function SchemeFinder() {
  const [activeTab, setActiveTab] = useState("all");
  const [searchQuery, setSearchQuery] = useState("");
  const [selectedState, setSelectedState] = useState("all");
  const [selectedCategory, setSelectedCategory] = useState("all");
  const [user, setUser] = useState(null);
  const [showEligibilityForm, setShowEligibilityForm] = useState(false);
  const [matchedSchemes, setMatchedSchemes] = useState([]);
  const [isAIMatching, setIsAIMatching] = useState(false);

  const { data: schemes, isLoading } = useQuery({
    queryKey: ['schemes'],
    queryFn: () => base44.entities.GovernmentScheme.list('-created_date'),
    initialData: []
  });

  useEffect(() => {
    const loadUser = async () => {
      try {
        const currentUser = await base44.auth.me();
        setUser(currentUser);
      } catch (error) {
        console.log("User not logged in");
      }
    };
    loadUser();
  }, []);

  const filteredSchemes = schemes.filter(scheme => {
    const matchesSearch = scheme.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                         scheme.description?.toLowerCase().includes(searchQuery.toLowerCase());
    const matchesState = selectedState === "all" || scheme.state === selectedState;
    const matchesCategory = selectedCategory === "all" || scheme.category === selectedCategory;
    const matchesActive = scheme.active !== false;
    
    return matchesSearch && matchesState && matchesCategory && matchesActive;
  });

  const states = ["Central", "Andhra Pradesh", "Gujarat", "Maharashtra", "Tamil Nadu", "Karnataka", "Uttar Pradesh", "West Bengal", "Rajasthan", "Punjab", "Kerala"];
  const categories = ["Agriculture", "Education", "Healthcare", "Housing", "Women Empowerment", "Senior Citizens", "Financial Assistance", "Employment", "Business & Entrepreneurship", "Social Welfare", "Skill Development"];

  const handleAIPersonalizedMatch = async () => {
    if (!user) {
      toast.error("Please login for AI personalized matching");
      base44.auth.redirectToLogin();
      return;
    }

    setIsAIMatching(true);
    try {
      const userProfile = {
        age: user.age || 30,
        state: user.state || "India",
        occupation: user.occupation || "Not specified",
        income: user.income || 0,
        gender: user.gender || "Not specified",
        education: user.education || "Not specified"
      };

      const result = await base44.integrations.Core.InvokeLLM({
        prompt: `You are an AI scheme matching expert. Analyze this user profile and match them with the most relevant government schemes from the list provided.

User Profile: ${JSON.stringify(userProfile)}

Available Schemes: ${JSON.stringify(schemes.map(s => ({ 
  id: s.id, 
  name: s.name, 
  description: s.description, 
  category: s.category,
  state: s.state,
  eligibility_criteria: s.eligibility_criteria 
})))}

Instructions:
1. Match schemes based on user's age, state, occupation, income, gender, and education
2. Prioritize schemes from user's state or Central schemes
3. Consider eligibility criteria carefully
4. Return top 10 most relevant schemes
5. Provide brief reasoning for the match

Return ONLY a JSON object with 'matched_scheme_ids' (array of strings) and 'reasoning' (string explaining the matching logic).`,
        response_json_schema: {
          type: "object",
          properties: {
            matched_scheme_ids: { type: "array", items: { type: "string" } },
            reasoning: { type: "string" }
          },
          required: ["matched_scheme_ids", "reasoning"]
        }
      });

      const aiMatched = schemes.filter(s => result.matched_scheme_ids?.includes(s.id));
      setMatchedSchemes(aiMatched);
      setActiveTab("matched");
      toast.success(`AI found ${aiMatched.length} personalized schemes for you!`);
    } catch (error) {
      console.error("AI matching failed:", error);
      toast.error("AI matching failed. Please try again.");
    } finally {
      setIsAIMatching(false);
    }
  };

  const handleEligibilityCheck = (userProfile) => {
    const matched = schemes.filter(scheme => {
      if (!scheme.eligibility_criteria) return true;
      
      const criteria = scheme.eligibility_criteria;
      let matches = true;

      if (criteria.min_age && userProfile.age < criteria.min_age) matches = false;
      if (criteria.max_age && userProfile.age > criteria.max_age) matches = false;
      if (criteria.income_limit && userProfile.income > criteria.income_limit) matches = false;
      if (criteria.occupation?.length && !criteria.occupation.includes(userProfile.occupation)) matches = false;
      if (criteria.social_category?.length && !criteria.social_category.includes(userProfile.social_category)) matches = false;
      
      return matches;
    });

    setMatchedSchemes(matched);
    setActiveTab("matched");
    setShowEligibilityForm(false);
    toast.success(`Found ${matched.length} schemes you may be eligible for!`);
  };

  const handleSaveScheme = async (schemeId) => {
    if (!user) {
      toast.error("Please login to save schemes");
      base44.auth.redirectToLogin();
      return;
    }

    try {
      await base44.entities.SavedScheme.create({
        user_id: user.id,
        scheme_id: schemeId
      });
      toast.success("Scheme saved successfully!");
    } catch (error) {
      toast.error("Failed to save scheme");
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
      <div className="bg-gradient-to-br from-orange-500 to-orange-600 text-white shadow-xl">
        <div className="max-w-7xl mx-auto px-4 py-12 md:py-16">
          <div className="flex items-center gap-4 mb-6">
            {/* Scheme Finder SVG Logo */}
            <svg className="w-16 h-16" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="schemeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style={{stopColor: '#F97316', stopOpacity: 1}} />
                  <stop offset="100%" style={{stopColor: '#EA580C', stopOpacity: 1}} />
                </linearGradient>
              </defs>
              <rect x="20" y="40" width="60" height="40" fill="url(#schemeGradient)"/>
              <polygon points="20,40 50,15 80,40" fill="url(#schemeGradient)"/>
              <rect x="35" y="55" width="10" height="15" fill="white"/>
              <rect x="55" y="55" width="10" height="15" fill="white"/>
              <rect x="45" y="50" width="10" height="20" fill="white"/>
              <circle cx="50" cy="30" r="6" fill="white"/>
            </svg>
            <div>
              <h1 className="text-3xl md:text-4xl font-bold flex items-center gap-2">
                <Building2 className="w-8 h-8" />
                Scheme Finder
              </h1>
              <p className="text-orange-100 mt-1">ðŸ”” Real-time updates â€¢ AI matching â€¢ 500+ schemes</p>
            </div>
          </div>

          <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
            <p className="text-orange-50 text-sm">
              ðŸ’¡ <strong>Pro Tip:</strong> Use AI matching for personalized recommendations or complete the eligibility questionnaire
            </p>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 py-8">
        {!showEligibilityForm && (
          <div className="grid md:grid-cols-3 gap-4 mb-8">
            <Card className="border-2 border-orange-200 bg-gradient-to-br from-orange-50 to-white hover:shadow-lg transition-shadow">
              <CardContent className="p-6">
                <div className="flex items-start gap-3 mb-3">
                  <Target className="w-8 h-8 text-orange-600" />
                  <div>
                    <h3 className="font-semibold text-gray-900">Manual Eligibility Check</h3>
                    <p className="text-sm text-gray-600 mt-1">Answer questions to find eligible schemes</p>
                  </div>
                </div>
                <Button 
                  onClick={() => setShowEligibilityForm(true)}
                  className="w-full bg-orange-600 hover:bg-orange-700 text-white"
                >
                  Check Eligibility
                </Button>
              </CardContent>
            </Card>

            <Card className="border-2 border-purple-200 bg-gradient-to-br from-purple-50 to-white hover:shadow-lg transition-shadow">
              <CardContent className="p-6">
                <div className="flex items-start gap-3 mb-3">
                  <Sparkles className="w-8 h-8 text-purple-600" />
                  <div>
                    <h3 className="font-semibold text-gray-900">AI Personalized Matching</h3>
                    <p className="text-sm text-gray-600 mt-1">Let AI analyze your profile automatically</p>
                  </div>
                </div>
                <Button 
                  onClick={handleAIPersonalizedMatch}
                  disabled={isAIMatching}
                  className="w-full bg-purple-600 hover:bg-purple-700 text-white"
                >
                  {isAIMatching ? (
                    <>
                      <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                      AI Analyzing...
                    </>
                  ) : (
                    <>
                      <Bot className="w-4 h-4 mr-2" />
                      AI Match Schemes
                    </>
                  )}
                </Button>
              </CardContent>
            </Card>

            <Card className="border-2 border-blue-200 bg-gradient-to-br from-blue-50 to-white">
              <CardContent className="p-6">
                <div className="flex items-start gap-3 mb-4">
                  <TrendingUp className="w-8 h-8 text-blue-600" />
                  <div>
                    <h3 className="font-semibold text-gray-900">Quick Stats</h3>
                    <p className="text-2xl font-bold text-blue-600 mt-1">{schemes.length}</p>
                    <p className="text-sm text-gray-600">Active Schemes</p>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        )}

        {showEligibilityForm && (
          <EligibilityForm 
            onSubmit={handleEligibilityCheck}
            onCancel={() => setShowEligibilityForm(false)}
          />
        )}

        <Card className="mb-6">
          <CardContent className="p-6">
            <div className="grid md:grid-cols-4 gap-4">
              <div className="md:col-span-2">
                <Label htmlFor="search">Search Schemes</Label>
                <div className="relative">
                  <Search className="absolute left-3 top-3 w-4 h-4 text-gray-400" />
                  <Input
                    id="search"
                    placeholder="Search by name or keyword..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="pl-10"
                  />
                </div>
              </div>

              <div>
                <Label>State</Label>
                <Select value={selectedState} onValueChange={setSelectedState}>
                  <SelectTrigger>
                    <SelectValue placeholder="All States" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">All States</SelectItem>
                    {states.map(state => (
                      <SelectItem key={state} value={state}>{state}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label>Category</Label>
                <Select value={selectedCategory} onValueChange={setSelectedCategory}>
                  <SelectTrigger>
                    <SelectValue placeholder="All Categories" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">All Categories</SelectItem>
                    {categories.map(cat => (
                      <SelectItem key={cat} value={cat}>{cat}</SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>
          </CardContent>
        </Card>

        <Tabs value={activeTab} onValueChange={setActiveTab} className="mb-6">
          <TabsList className="grid w-full md:w-auto grid-cols-2">
            <TabsTrigger value="all">
              All Schemes ({filteredSchemes.length})
            </TabsTrigger>
            <TabsTrigger value="matched">
              Matched For You ({matchedSchemes.length})
            </TabsTrigger>
          </TabsList>
        </Tabs>

        {isLoading ? (
          <div className="grid md:grid-cols-2 gap-6">
            {[...Array(6)].map((_, i) => (
              <Card key={i} className="animate-pulse">
                <CardHeader>
                  <div className="h-6 bg-gray-200 rounded w-3/4 mb-2" />
                  <div className="h-4 bg-gray-200 rounded w-full" />
                </CardHeader>
                <CardContent>
                  <div className="h-20 bg-gray-200 rounded" />
                </CardContent>
              </Card>
            ))}
          </div>
        ) : (
          <div className="grid md:grid-cols-2 gap-6">
            {activeTab === "all" ? (
              filteredSchemes.length > 0 ? (
                filteredSchemes.map(scheme => (
                  <SchemeCard 
                    key={scheme.id} 
                    scheme={scheme}
                    onSave={() => handleSaveScheme(scheme.id)}
                  />
                ))
              ) : (
                <div className="col-span-2 text-center py-12">
                  <Building2 className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                  <p className="text-gray-500 text-lg">No schemes found matching your criteria</p>
                </div>
              )
            ) : (
              matchedSchemes.length > 0 ? (
                matchedSchemes.map(scheme => (
                  <SchemeCard 
                    key={scheme.id} 
                    scheme={scheme}
                    onSave={() => handleSaveScheme(scheme.id)}
                    isMatched
                  />
                ))
              ) : (
                <div className="col-span-2 text-center py-12">
                  <Building2 className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                  <p className="text-gray-500 text-lg mb-2">No matched schemes yet</p>
                  <p className="text-gray-400 mb-4">Use AI matching or eligibility check to find personalized schemes</p>
                  <div className="flex justify-center gap-4">
                    <Button onClick={() => setShowEligibilityForm(true)}>
                      Check Eligibility
                    </Button>
                    <Button 
                      onClick={handleAIPersonalizedMatch}
                      disabled={isAIMatching}
                      className="bg-purple-600 hover:bg-purple-700 text-white"
                    >
                      {isAIMatching ? (
                        <>
                          <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                          AI Analyzing...
                        </>
                      ) : (
                        <>
                          <Bot className="w-4 h-4 mr-2" />
                          AI Match
                        </>
                      )}
                    </Button>
                  </div>
                </div>
              )
            )}
          </div>
        )}
      </div>
    </div>
  );
}